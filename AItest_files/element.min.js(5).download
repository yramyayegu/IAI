define(["jquery","knockout","pubsub","ccConstants","ccRestClient","notifications","navigation"],function(e,t,n,r,i,s,o){"use strict";return{elementName:"header-ou-language-picker",selectedLocaleId:t.observable(),selectedLocale:t.observable(),languageLinkText:t.observable(""),languageDropdownVisible:t.observable(!1),supportedLocales:t.observableArray([]),redirectToLink:t.observable("#"),onLoad:function(s){var u=this;s.site().additionalLanguages&&u.supportedLocales(s.site().additionalLanguages),u.sortLocales();var a=s.locale(),f=a.replace("-","_"),l=e.grep(u.supportedLocales(),function(e){return e.name===f}),c=e.grep(u.supportedLocales(),function(e){return e.name===s.locale()});!s.user().locale()&&s.user().loggedIn()&&e.Topic(n.topicNames.USER_LOCALE_NOT_SUPPORTED).publish();var h=JSON.parse(i.getStoredValue(r.LOCAL_STORAGE_USER_CONTENT_LOCALE));if(!h||!h[0])l&&l[0]?(u.selectedLocale(l[0]),u.selectedLocaleId(l[0].localeId),i.setStoredValue(r.LOCAL_STORAGE_USER_CONTENT_LOCALE,t.toJSON(l))):c&&c[0]?(u.selectedLocale(c[0]),u.selectedLocaleId(c[0].localeId),i.setStoredValue(r.LOCAL_STORAGE_USER_CONTENT_LOCALE,t.toJSON(c))):(e.Topic(n.topicNames.USER_LOCALE_NOT_SUPPORTED).publish(),window.location.reload());else if(!u.selectedLocale()&&!u.selectedLocaleId()){var p=e.grep(u.supportedLocales(),function(e){return e.localeId===h[0].localeId});p&&p[0]?(u.selectedLocale(p[0]),u.selectedLocaleId(p[0].localeId)):(i.clearStoredValue(r.LOCAL_STORAGE_USER_CONTENT_LOCALE),window.location.reload())}u.selectedLocaleId.subscribe(function(t){var n=e.grep(u.supportedLocales(),function(e){return e.localeId===t});n&&n.length>0&&n[0].localeId!=u.selectedLocale().localeId&&(u.selectedLocale(n[0]),u.selectedLocaleId(n[0].localeId),s.user().loggedIn()||s.redirectToLocalizedURL(u.selectedLocale().name,c[0].name))}.bind(u)),u.selectedLocale()&&u.languageLinkText(u.selectedLocale().displayName),u.handleLanguageChange=function(e){var t=this;t.redirectToLink("/"+o.getPath());if(s.user().isUserProfileEdited())return!0;e&&t.selectedLocaleId(e.localeId),s.user().loggedIn()&&t.handleUpdateProfileLocale();if(o.getRelativePath().indexOf(s.links().searchresults.route)!==-1){var n=decodeURIComponent(window.location.search);n=n.replace("?","");var r=n.split("&"),i="";for(var u=0;u<r.length;u++)r[u].split("=")[0]==="Nr"?i===""?i="Nr="+s.processNrParameter(r[u].split("=")[1],"language-picker"):i=i+"&"+"Nr="+s.processNrParameter(r[u].split("=")[1],"language-picker"):i===""?i=r[u]:i=i+"&"+r[u];var a=o.getBaseURL()+"/"+e.name+o.getPathWithoutLocale().split("?")[0]+"?"+i;window.location.assign(a)}},u.handleUpdateProfileLocale=function(){s.user().locale(u.selectedLocale().name),s.user().locale.isModified!==undefined&&(s.user().locale.isModified(!0),e.Topic(n.topicNames.USER_PROFILE_UPDATE_SUBMIT).publishWith(s.user(),[{message:"success"}])),s.user().locale.isModified!==undefined&&s.user().locale.isModified(!1)},u.saveLocaleToHeader=function(){var e=JSON.parse(i.getStoredValue(r.LOCAL_STORAGE_USER_CONTENT_LOCALE));if(Array.isArray(e))var e=e[0].name;else var e=e.name;e!==u.selectedLocale().name?s.redirectToLocalizedURL(u.selectedLocale().name,e):e!==s.user().locale()&&s.redirectToLocalizedURL(s.user().locale(),e)},e.Topic(n.topicNames.USER_LOGIN_SUCCESSFUL).subscribe(function(t){s.user().locale()?u.setProfileLocaleAsStoreLocale():e.Topic(n.topicNames.USER_LOAD_SHIPPING).subscribe(u.setProfileLocaleAsStoreLocale)}),u.setProfileLocaleAsStoreLocale=function(){if(u.selectedLocale().name!==s.user().locale())for(var t=0;t<s.site().additionalLanguages.length;t++)if(s.user().locale()===s.site().additionalLanguages[t].name){s.redirectToLocalizedURL(s.user().locale(),u.selectedLocale().name);break}e.Topic(n.topicNames.USER_LOAD_SHIPPING).unsubscribe()},e.Topic(n.topicNames.USER_PROFILE_UPDATE_SUCCESSFUL).subscribe(function(){u.saveLocaleToHeader()}),e.Topic(n.topicNames.USER_PROFILE_UPDATE_INVALID).subscribe(function(){u.saveLocaleToHeader()}),e.Topic(n.topicNames.USER_PROFILE_UPDATE_FAILURE).subscribe(function(){u.saveLocaleToHeader()})},sortLocales:function(){var e=this;this.supportedLocales.sort(function(e,t){return e.displayName==t.displayName?0:e.displayName<t.displayName?-1:1})},keypressLanguageHandler:function(t,n){var i,s,o;i=this,s=e(n.target),o=n.which?n.which:n.keyCode,n.shiftKey&&o==r.KEY_CODE_TAB&&(o=r.KEY_CODE_SHIFT_TAB);var u="CC-header-languagePicker-"+(i.supportedLocales().length-1);switch(o){case r.KEY_CODE_TAB:s[0].id===u&&i.hideLanguageDropDown();break;case r.KEY_CODE_SHIFT_TAB:s[0].id==="CC-header-language-link"&&i.hideLanguageDropDown()}return!0},showLanguageDropDown:function(){this.languageDropdownVisible(!0),s.emptyGrowlMessages(),e("#languagedropdown").addClass("active"),e("#languagedropdown > .content").fadeIn("slow"),e(document).on("mouseleave","#languagedropdown",function(){e("#languagedropdown > .content").fadeOut("slow"),e(this).removeClass("active")});var t=navigator.userAgent.match(r.IPAD_STRING)!=null;t&&e(document).on("touchend",function(t){e(t.target).closest("#languagedropdown").length||(e("#languagedropdown > .content").fadeOut("slow"),e("#languagedropdown").removeClass("active"))})},hideLanguageDropDown:function(){return this.languageDropdownVisible(!1),e("#languagedropdown > .content").fadeOut("slow"),e("#languagedropdown").removeClass("active"),!0},toggleLanguageDropDown:function(){this.redirectToLink("/"+o.getPath()),e("#languagedropdown").hasClass("active")?this.hideLanguageDropDown():this.showLanguageDropDown()}}})