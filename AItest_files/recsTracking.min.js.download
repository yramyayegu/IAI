define(["pubsub","ccLogger","ccRestClient","ccConstants","js/recsRequest","js/gdprConsent","pageLayout/cart","pageLayout/search","storageApi","swmRestClient"],function(e,t,n,r,i,s,o,u,a,f){"use strict";var l="pr/",c=a.getInstance(),h=function(e){var t=e.items(),n,r=t.length,i=[];while(r--)n=t[r],i.push(n.productId);return i},p=function(e){var t=e.items(),n,r=t.length,i=[],s=e.total();while(r--)n=t[r],i.push({productId:n.productId,quantity:n.quantity(),price:n.itemTotal()});return[i,s]},d=function(){o.singleInstance.items().length>0?S().addResource("cart",{cart:{productIds:h(o.singleInstance),pricelistGroupId:o.singleInstance.cartPriceListGroupId(),currencyCode:o.singleInstance.currencyCode()}}):S().addResource("cart",{cart:{productIds:h(o.singleInstance)}})},v=function(e){var t={},n=e.pageId,r=e.contextId;return n=="product"?t.productId=r:n=="home"||n=="search"||n=="cart",t},m={},g,y,b={},w=document.referrer,E=function(){return y.site().tenantId},S=function(){return g||(g=new i.RESTRequest(_)),g},x="occsRecVisitorId",T="occsRecSessionId",N="occsRecPricelistGroupId",C="occsRecCurrencyCode",k="occsRecSendCart",L="occsRecPayUCheckoutInfo",A=function(e,t){return e?(t&&(s.hasP13nCookieConsent(y.site())?(c.removeSessionItem(e),c.hasCookiesSupport()&&c.readFromCookies(e)!==null&&c.saveToCookies(e,"",-1),c.setItem(e,t)):(c.removeItem(e),c.setSessionItem(e,t)),m[e]=t),m[e]||c.getSessionItem(e)||c.getItem(e)):null},O=function(e){return A(x,e)},M=function(e){return A(T,e)},_=function(e){var t=y.recsHostPortPath+"/"+e+"/3.0/json/"+E()+(O()?"/"+O():"")+(M()?"?sessionId="+M():"");return t},D=function(e){e&&(e.visitorId&&O(e.visitorId),e.sessionId&&M(e.sessionId))},P=function(t){var n=t,r={};r.data=t,r.visitorId=O(),r.sessionId=M(),$.Topic(e.topicNames.RECS_HAVE_RECS).publish(r)},H=function(e,i){if(i!=null){var s=function(n){var r=n.categoryIdPaths;Array.isArray(r)&&r.length>0?y.categoryPath=r[0]:t.warning("[recsTracking] Could not determine category path."),B(e)},o=function(n){t.warning("[recsTracking] addCategoryPathAndSend failed."),B(e)};n.request(r.ENDPOINT_COLLECTIONS_GET_COLLECTION,null,s,o,i)}else t.warning("[recsTracking] addCategoryPathAndSend failed. categoryId was null."),B(e)},B=function(e){if(!y.recsHostPortPath)return;if(!E())return;y.localWishlists!=null&&y.localWishlists!=undefined&&Object.getOwnPropertyNames(y.localWishlists).length!=0&&S().addResource("wishlists",{wishlists:y.localWishlists}),y.slots!=null&&y.slots!=undefined&&Object.getOwnPropertyNames(y.slots).length!=0&&S().addResource("recommendations",{slots:y.slots});var t={url:document.location.href},r=S();n.profileId&&r.addParam({customerId:n.profileId}),s.hasP13nCookieConsent(y.site())||r.addParam({gdpr:!0}),w&&(t.referrer=w,w=0),e.pageId==="product"&&(t.productId=e.contextId),y.categoryPath&&(t.category=y.categoryPath),y.pageTitle&&(t.pageTitle=y.pageTitle),y.catalogId&&(t.storeId=y.catalogId,t.excludeDefaultStore=!0);var i=y.site().selectedPriceListGroup(),o=c.readFromSessionStorage(N),u=i.repositoryId;o!==u&&(u!=null&&u!=undefined?(c.saveToSessionStorage(N,u),t.pricelistGroupId=u):c.removeItem(N));var a=c.readFromSessionStorage(C),f=i.currency.currencyCode;a!==f&&(f!=null&&f!=undefined?(c.saveToSessionStorage(C,f),t.currencyCode=f):c.removeItem(C)),r.addResource("view",{view:t});var l=c.readFromSessionStorage(L);l&&(S().addResource("checkout",{checkout:JSON.parse(l)}),c.removeItem(L));var h=c.readFromSessionStorage(k);if(h===null||h===undefined||h==="true")d(),c.saveToSessionStorage(k,"false");r.addCallback(D,"tracking"),r.addCallback(P,"slots"),r.send(),g=0},j={},F=function(e){var t=e.items,n=[];if(t&&t.length>0){var r=0;for(r=0;r<t.length;r++)n.push(t[r].productProductId)}return n},I=function(){var e=function(e){var t,n=[],r=e.items,i=0;for(i=0;i<r.length;i++)t=r[i].spaceId,n=F(r[i].products),n.length>0&&(j[t]=n);Object.getOwnPropertyNames(j).length!=0&&(y.localWishlists=j)},t=function(e){};f.init(y.site().tenantId,y.isPreview(),y.locale()),f.request("GET","/swm/rs/v1/sites/{siteid}/spaces?expand=products","",e,t,{})};return $.Topic(e.topicNames.SEARCH_CREATE).subscribe(function(e){var t=u.getInstance().searchText;t&&S().addResource("view",{view:{searchText:t}})}),$.Topic(e.topicNames.SEARCH_TYPEAHEAD).subscribe(function(e){var t=this.searchText;t&&S().addResource("view",{view:{searchText:t}})}),$.Topic(e.topicNames.ORDER_COMPLETED).subscribe(function(e){var t=p(o.singleInstance);S().addResource("checkout",{checkout:{products:t[0],totalPrice:t[1],pricelistGroupId:o.singleInstance.cartPriceListGroupId(),currencyCode:o.singleInstance.currencyCode()}})}),$.Topic(e.topicNames.PAYULATAM_WEB_CHECKOUT).subscribe(function(e){var t=p(o.singleInstance);if(t[1]>0){var n={products:t[0],totalPrice:t[1],pricelistGroupId:o.singleInstance.cartPriceListGroupId(),currencyCode:o.singleInstance.currencyCode()};c.saveToSessionStorage(L,JSON.stringify(n))}}),$.Topic(e.topicNames.PAGE_CHANGED).subscribe(function(e){S().addResource("view",{view:v(e)})}),$.Topic(e.topicNames.CART_UPDATED).subscribe(function(e){c.saveToSessionStorage(k,"true")}),{onLoad:function(t){y=t;var n=function(e,t){var n={"Top Sellers":"topSellers","Browsed Together":"topCobrowses","Purchased Together":"topCobuys","Most Recently Viewed":"mostRecentlyViewed","In Brand":"inBrand","In Collection":"inCategory"},r=[];return e=="Top Sellers"&&t=="In Brand"?r.push("topSellersInBrand"):e=="Top Sellers"&&t=="In Collection"?r.push("topSellersInCategory"):(n[e]&&r.push(n[e]),n[t]&&r.push(n[t])),r};$.Topic(e.topicNames.RECS_WANT_RECS).subscribe(function(e){var t=e.id,r=e.numRecs,i=e.strategy,s=e.restriction,o=null;if(y.slots==undefined||y.slots==null)y.slots={};y.slots[t]={},y.slots[t].numRecs=r,o=n(i,s),y.slots[t].rule=o,y.slots[t].dataItems=["repositoryid"],y.excludeList.length>0&&(y.slots[t].exclude=y.excludeList);if(!!e.customParams){var u=Object.keys(e.customParams);for(var a=0;a<u.length;a++)y.slots[t][u[a]]=e.customParams[u[a]]}}),y.user().loggedIn()&&I();var r=function(e,t){y.localWishlists==null||y.localWishlists==undefined?e!=null&&t!=null&&(y.localWishlists={},y.localWishlists[e]=[t]):e!=null&&t!=null&&(y.localWishlists[e]?y.localWishlists[e].push(t):y.localWishlists[e]=[t]),y.localWishlists&&S().addResource("wishlists",{wishlists:y.localWishlists})};$.Topic(e.topicNames.USER_LOGIN_SUCCESSFUL).subscribe(function(e){I()}),$.Topic(e.topicNames.SOCIAL_SPACE_ADD_SUCCESS).subscribe(function(e){var t;y&&y.product&&y.product()&&(t=y.product().id());var n=e.spaceId;n!=null&&t!=null&&r(n,t)})},beforeAppear:function(i){y.slots=null,y.categoryPath=null,y.pageTitle=document.title,y.catalogId=y.user().catalogId(),y.excludeList=[];if(y&&y.product&&y.product()&&y.product().relatedProducts){var s=y.product().relatedProducts,o;for(o=0;o<s.length;o++)y.excludeList.push(s[o].id)}var u={};u.pageId=i.pageId,$.Topic(e.topicNames.RECS_WHO_WANT_RECS).publish(u);var a=function(e){var t=e.serviceData.host,n=e.serviceData.port,r=e.serviceData.path,s="";n&&n!==null&&n!==""&&n!=="0"&&(s=":"+n),t&&r&&(y.recsHostPortPath="//"+t+s+"/"+r,i.pageId=="category"?H(i,i.contextId):B(i))},f=function(e){t.warning("Failed to get Recs hostname.",e)};y.recsHostPortPath?i.pageId=="category"?H(i,i.contextId):B(i):n.request(r.ENDPOINT_MERCHANT_GET_EXTERNALDATA,null,a,f,r.EXTERNALDATA_PRODUCTION_RECS)},deferSendOnPage:function(e){b[e]=1}}})